name: Create GitHub Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: macos-26

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Import Apple signing certificate
        env:
          P12_BASE64: ${{ secrets.APPLE_CERT_P12_BASE64 }}
          P12_PASSWORD: ${{ secrets.APPLE_CERT_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          KEYCHAIN_PATH="$RUNNER_TEMP/computer-solitaire-signing.keychain-db"
          CERT_PATH="$RUNNER_TEMP/computer-solitaire-signing.p12"
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> "$GITHUB_ENV"

          if [[ -z "${P12_BASE64:-}" || -z "${P12_PASSWORD:-}" || -z "${APPLE_TEAM_ID:-}" ]]; then
            echo "Missing required signing secrets: APPLE_CERT_P12_BASE64, APPLE_CERT_PASSWORD, APPLE_TEAM_ID"
            exit 1
          fi

          printf '%s' "$P12_BASE64" | base64 -D -o "$CERT_PATH"

          security create-keychain -p "" "$KEYCHAIN_PATH"
          security set-keychain-settings "$KEYCHAIN_PATH"
          security unlock-keychain -p "" "$KEYCHAIN_PATH"
          security import "$CERT_PATH" \
            -k "$KEYCHAIN_PATH" \
            -P "$P12_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security
          security set-key-partition-list \
            -S apple-tool:,apple: \
            -s \
            -k "" \
            "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" login.keychain-db

      - name: Build macOS app archive
        run: |
          xcodebuild archive \
            -project ComputerSolitaire.xcodeproj \
            -scheme ComputerSolitaire \
            -destination "generic/platform=macOS" \
            -archivePath build/ComputerSolitaire.xcarchive \
            -configuration Release \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Developer ID Application" \
            DEVELOPMENT_TEAM="${{ secrets.APPLE_TEAM_ID }}" \
            OTHER_CODE_SIGN_FLAGS="--keychain $KEYCHAIN_PATH" \
            ARCHS=arm64

      - name: Create DMG
        run: |
          mkdir -p dmg-contents

          APP_PATH="$(find build/ComputerSolitaire.xcarchive/Products/Applications -maxdepth 1 -name '*.app' -print -quit)"
          if [[ -z "${APP_PATH}" ]]; then
            echo "No .app bundle found in archive output."
            exit 1
          fi

          cp -R "${APP_PATH}" dmg-contents/
          hdiutil create \
            -volname "Computer Solitaire" \
            -srcfolder dmg-contents \
            -ov \
            -format UDZO \
            "ComputerSolitaire-${{ github.ref_name }}-arm64.dmg"

      - name: Sign DMG
        run: |
          DMG_PATH="ComputerSolitaire-${{ github.ref_name }}-arm64.dmg"
          codesign --force \
            --sign "Developer ID Application" \
            --keychain "$KEYCHAIN_PATH" \
            --timestamp \
            "$DMG_PATH"

      - name: Prepare notary API key
        env:
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          APPLE_API_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
          APPLE_API_PRIVATE_KEY_BASE64: ${{ secrets.APPLE_API_PRIVATE_KEY_BASE64 }}
        run: |
          if [[ -z "${APPLE_API_KEY_ID:-}" || -z "${APPLE_API_ISSUER_ID:-}" || -z "${APPLE_API_PRIVATE_KEY_BASE64:-}" ]]; then
            echo "Missing required notarization secrets: APPLE_API_KEY_ID, APPLE_API_ISSUER_ID, APPLE_API_PRIVATE_KEY_BASE64"
            exit 1
          fi

          NOTARY_API_KEY_PATH="$RUNNER_TEMP/AuthKey_${APPLE_API_KEY_ID}.p8"
          printf '%s' "$APPLE_API_PRIVATE_KEY_BASE64" | base64 -D -o "$NOTARY_API_KEY_PATH"
          chmod 600 "$NOTARY_API_KEY_PATH"
          echo "NOTARY_API_KEY_PATH=$NOTARY_API_KEY_PATH" >> "$GITHUB_ENV"

      - name: Notarize DMG
        env:
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          APPLE_API_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
        run: |
          DMG_PATH="ComputerSolitaire-${{ github.ref_name }}-arm64.dmg"
          xcrun notarytool submit "$DMG_PATH" \
            --key "$NOTARY_API_KEY_PATH" \
            --key-id "$APPLE_API_KEY_ID" \
            --issuer "$APPLE_API_ISSUER_ID" \
            --wait

      - name: Staple notarization ticket
        run: |
          DMG_PATH="ComputerSolitaire-${{ github.ref_name }}-arm64.dmg"
          xcrun stapler staple "$DMG_PATH"
          xcrun stapler validate "$DMG_PATH"

      - name: Verify signed artifact
        run: |
          APP_PATH="$(find build/ComputerSolitaire.xcarchive/Products/Applications -maxdepth 1 -name '*.app' -print -quit)"
          if [[ -z "${APP_PATH}" ]]; then
            echo "No .app bundle found in archive output."
            exit 1
          fi

          DMG_PATH="ComputerSolitaire-${{ github.ref_name }}-arm64.dmg"
          codesign --verify --deep --strict --verbose=2 "$APP_PATH"
          spctl --assess --type execute --verbose=4 "$APP_PATH"
          codesign --verify --verbose=2 "$DMG_PATH"
          xcrun stapler validate "$DMG_PATH"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          DMG_PATH="ComputerSolitaire-${{ github.ref_name }}-arm64.dmg"
          if gh release view "${{ github.ref_name }}" >/dev/null 2>&1; then
            gh release upload "${{ github.ref_name }}" "$DMG_PATH" --clobber
          else
            gh release create "${{ github.ref_name }}" \
              --title "${{ github.ref_name }}" \
              --generate-notes \
              "$DMG_PATH"
          fi

      - name: Cleanup signing keychain
        if: always()
        run: |
          if [[ -n "${KEYCHAIN_PATH:-}" ]]; then
            security delete-keychain "$KEYCHAIN_PATH" || true
          fi
          if [[ -n "${NOTARY_API_KEY_PATH:-}" ]]; then
            rm -f "$NOTARY_API_KEY_PATH"
          fi
